CREATE TABLE apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  api_key TEXT UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT now()
);
CREATE TABLE dialpad_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  dialpad_org_id BIGINT,
  access_token TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  token_expires_at TIMESTAMP NOT NULL,
  environment TEXT CHECK (environment IN ('sandbox', 'production')),
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);
CREATE TABLE dialpad_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  dialpad_user_id BIGINT UNIQUE NOT NULL,
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  name TEXT,
  email TEXT,
  created_at TIMESTAMP DEFAULT now()
);
CREATE TABLE calls (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  dialpad_call_id BIGINT UNIQUE NOT NULL,
  direction TEXT CHECK (direction IN ('inbound', 'outbound')),
  from_number TEXT,
  to_number TEXT,
  status TEXT,
  dialpad_user_id BIGINT,
  started_at TIMESTAMP,
  ended_at TIMESTAMP,
  duration_seconds INTEGER,
  recording_url TEXT,
  raw_payload JSONB,
  created_at TIMESTAMP DEFAULT now()
);
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  dialpad_message_id BIGINT UNIQUE NOT NULL,
  direction TEXT CHECK (direction IN ('inbound', 'outbound')),
  from_number TEXT,
  to_number TEXT,
  text TEXT,
  dialpad_user_id BIGINT,
  sent_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT now()
);
CREATE TABLE webhook_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id),
  event_type TEXT,
  dialpad_event_id TEXT,
  payload JSONB NOT NULL,
  received_at TIMESTAMP DEFAULT now()
);
ALTER TABLE calls
ADD COLUMN is_voicemail BOOLEAN DEFAULT false,
ADD COLUMN voicemail_audio_url TEXT,
ADD COLUMN voicemail_transcript TEXT;
